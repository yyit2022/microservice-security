<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="yyit">
<title>微服务安全第二课(保护微服务的第一步)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>微服务安全第二课(保护微服务的第一步)</h1>
<div class="details">
<span id="author" class="author">yyit</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel1">
<li><a href="#_1_构建你的第一个微服务">1. 构建你的第一个微服务</a>
<ul class="sectlevel2">
<li><a href="#_1_1_克隆示例库">1.1. 克隆示例库</a></li>
<li><a href="#_1_2_编译订单处理微服务">1.2. 编译订单处理微服务</a></li>
<li><a href="#_1_3_访问订单处理微服务">1.3. 访问订单处理微服务</a></li>
<li><a href="#_1_4_源代码目录中有什么">1.4 源代码目录中有什么？</a></li>
<li><a href="#_1_5_理解微服务的源代码">1.5 理解微服务的源代码</a></li>
</ul>
</li>
<li><a href="#_2_设置_oauth_2_服务器">2. 设置 OAuth 2 服务器</a>
<ul class="sectlevel2">
<li><a href="#_2_1_与授权服务器的交互">2.1 与授权服务器的交互</a></li>
<li><a href="#_2_2_运行_oauth_2_授权服务器">2.2 运行 OAuth 2 授权服务器</a></li>
<li><a href="#_2_3_从_oauth_2_授权服务器获取访问令牌">2.3 从 OAuth 2 授权服务器获取访问令牌</a></li>
<li><a href="#_2_4_理解访问令牌响应">2.4 理解访问令牌响应</a></li>
</ul>
</li>
<li><a href="#_3_使用_oauth_2_保护微服务">3 使用 OAuth 2 保护微服务</a>
<ul class="sectlevel2">
<li><a href="#_3_1_基于_oauth_2_的保护">3.1 基于 OAuth 2 的保护</a></li>
<li><a href="#_3_2_运行示例">3.2 运行示例</a></li>
</ul>
</li>
<li><a href="#_4_从客户端应用程序调用安全的微服务">4 从客户端应用程序调用安全的微服务</a></li>
<li><a href="#_5_使用_oauth_2_scope_执行服务级别授权">5 使用 OAuth 2 scope 执行服务级别授权</a>
<ul class="sectlevel2">
<li><a href="#_5_1_从授权服务器获取作用域访问令牌">5.1 从授权服务器获取作用域访问令牌</a></li>
<li><a href="#_5_2_使用_oauth_2_0_scope_保护对微服务的访问">5.2 使用 OAuth 2.0 scope 保护对微服务的访问</a></li>
</ul>
</li>
<li><a href="#_总结">总结</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_1_构建你的第一个微服务"><a class="link" href="#_1_构建你的第一个微服务">1. 构建你的第一个微服务</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>我们以一个零售商店应用程序为例，我们使用一组微服务来构建它。我们将使用 Spring Boot (<a href="https://spring.io/projects/spring-boot" class="bare">https://spring.io/projects/spring-boot</a>) 构建我们的第一个微服务，它接受创建和管理订单的请求。</p>
</div>
<div class="paragraph">
<p>Spring Boot 是一个基于 Spring 平台的框架，它允许您通过使用一组特殊的注解修饰您的代码，将用 Java 编程语言编写的函数转换为网络可访问的函数，称为服务或 API。
代码示例都可以在 GitHub (<a href="https://github.com/yyit2022/microservice-security" class="bare">https://github.com/yyit2022/microservice-security</a>) 上找到。</p>
</div>
<div class="paragraph">
<p>图 1 显示了一组微服务，它们是我们正在构建的零售商店应用程序的一部分，以及一组消费者应用程序。事实上，消费者应用程序是我们构建的微服务的消费者。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="doc/2.1.dio.png" alt="2.1.dio">
</div>
<div class="title">图 . 1 在这个典型的微服务部署中，消费者应用程序（Web 应用程序或移动应用程序）代表其最终用户访问微服务，而微服务之间相互通信。</div>
</div>
<div class="sect2">
<h3 id="_1_1_克隆示例库"><a class="link" href="#_1_1_克隆示例库">1.1. 克隆示例库</a></h3>
<div class="literalblock">
<div class="content">
<pre>(1) 克隆示例 Git 源码库,运行以下命令:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>git clone  https://github.com/yyit2022/microservice-security.git</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_编译订单处理微服务"><a class="link" href="#_1_2_编译订单处理微服务">1.2. 编译订单处理微服务</a></h3>
<div class="paragraph">
<p>完成克隆步骤后，就该动手运行您的第一个微服务了。首先，在您的操作系统中打开命令行工具，然后导航到文件系统上克隆示例源码库的位置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cd [microservice-security]/lesson02/sample01</pre>
</div>
</div>
<div class="paragraph">
<p>在 <code>lesson02/sample01</code> 目录中，您将找到与订单处理微服务对应的源代码。在该目录中，执行以下命令以构建订单处理微服务：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean install</pre>
</div>
</div>
<div class="paragraph">
<p>前面的命令指示 Maven 编译您的源代码并生成一个可运行的 artifact，称为 Java 存档 (JAR) 文件。请注意，您需要安装 Java 和 Maven 才能成功执行此步骤。如果您的构建成功，您将看到消息 <code>BUILD SUCCESS</code>。</p>
</div>
<div class="paragraph">
<p>如果构建成功，您应该在当前目录中看到一个名为 target 的目录。目标目录应包含名为 com.yyit.mss.ch02.sample01-1.0.jar 的文件。 （其他文件将在 <code>target</code> 目录中，但您目前对它们不感兴趣。）然后从 lesson02/sample01/ 目录运行以下命令以启动订单处理微服务。在这里，我们使用了一个名为 spring-boot 的 Maven 插件：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mvn spring-boot:run</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果微服务启动成功，您应该会在终端上看到一堆消息。在消息堆栈的底部，您应该会看到以下消息：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Started OrderApplication in &lt;X&gt; seconds</code></pre>
</div>
</div>
<div class="paragraph">
<p>默认情况下，Spring Boot 在 HTTP 8080 端口启动微服务。如果您的本地机器上有其他服务在 8080 端口上运行，请确保停止它们；或者，您可以通过在 <code>lesson02/sample01/src/main/resources/application.properties</code> 文件中适当地更改 <code>server.port</code> 属性的值来更改订单处理微服务的默认端口。</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_3_访问订单处理微服务"><a class="link" href="#_1_3_访问订单处理微服务">1.3. 访问订单处理微服务</a></h3>
<div class="paragraph">
<p>默认情况下，Spring Boot 运行嵌入式 Apache Tomcat Web 服务器，该服务器监听端口 8080 上的 HTTP 请求。
在这里您将使用 curl 作为客户端应用程序访问您的微服务。
如果您在自定义端口上运行订单处理微服务，请确保将以下命令中的端口 (8080) 值替换为您使用的值。
要调用微服务，请打开命令行客户端并执行以下 curl 命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell script">curl -v http://localhost:8080/orders \
-H 'Content-Type: application/json' \
--data-binary @- &lt;&lt; EOF
{
  &quot;items&quot;:[
    {
      &quot;itemCode&quot;:&quot;IT0001&quot;,
      &quot;quantity&quot;:3
    },
    {
      &quot;itemCode&quot;:&quot;IT0004&quot;,
      &quot;quantity&quot;:1
    }
  ],
  &quot;shippingAddress&quot;:&quot;福建省厦门市XX区XX街道XX小区XX栋XX室&quot;
}
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>应该在终端上看到类似以下的响应数据：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">{
  &quot;orderId&quot;:&quot;cd992a9f-6900-4625-b73a-0c526451dc81&quot;,
  &quot;items&quot;:[{
    &quot;itemCode&quot;:&quot;IT0001&quot;,&quot;quantity&quot;:3},
    {&quot;itemCode&quot;:&quot;IT0004&quot;,&quot;quantity&quot;:1}],
  &quot;shippingAddress&quot;:&quot;福建省厦门市XX区XX街道XX小区XX栋XX室&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果看到此消息，则您已成功开发、部署和测试了你的第一个微服务！</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
这个示例都使用 HTTP（而非 HTTPS）端点，这样您就不必设置正确的证书，并使您可以在需要时检查线路（网络）上传递的消息。在生产系统中，我们不建议对任何端点使用 HTTP。您应该仅通过 HTTPS 公开所有端点。在后面，我们将讨论如何使用 HTTPS 保护微服务。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>当您执行上述命令时，curl 向位于服务器 localhost 上端口 8080（本地机器）上的 /orders 资源发起了 HTTP POST 请求。请求的内容（有效负载）表示为将要传送到特定地址的两件商品下的订单。 Spring Boot 服务器运行时（嵌入式 Tomcat）将此请求分派给 Order Processing 微服务的 <code>placeOrder</code> 方法（在 Java 代码中），后者响应消息。</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_4_源代码目录中有什么"><a class="link" href="#_1_4_源代码目录中有什么">1.4 源代码目录中有什么？</a></h3>
<div class="paragraph">
<p>让我们在 sample01 目录中导航并检查其内容。您应该会看到一个名为 <code>pom.xml</code> 的文件和一个名为 <code>src</code> 的目录。导航到 src/main/java/com/yyit/mss/ch02/sample01/service/ 目录。您将看到两个文件：<code>OrderApplication.java</code> 和 <code>OrderProcesingService.java</code>。</p>
</div>
<div class="paragraph">
<p>在深入研究这些文件的内容之前，让我们解释一下在此处尝试构建的内容。
微服务是网络可访问功能的集合。
在这种情况下，网络可访问意味着这些功能可以通过 Web 浏览器和移动应用程序等应用程序或 curl (https:// curl.haxx.se/) 能够通过 HTTP 进行通信。
通常，微服务中的函数作为对 REST 资源 (<a href="https://spring.io/guides/tutorials/rest/" class="bare">https://spring.io/guides/tutorials/rest/</a>) 的操作公开。
通常，资源表示您打算检查或操作的对象或实体。
映射到 HTTP 时，资源通常由请求 URI 标识，verb 由 HTTP method(GET、POST、PUT、DELETE、OPTION、PATCH) 表示。</p>
</div>
<div class="paragraph">
<p>一个电子商务应用程序使用微服务来检索订单详细信息的场景。映射到微服务中该特定功能的 HTTP 请求模板类似于以下内容：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>GET /orders/{orderid}</pre>
</div>
</div>
<div class="paragraph">
<p><code>GET</code> 是本例中使用的 HTTP 方法，因为您正在执行数据检索操作。 <code>/orders/{orderid}</code> 是托管相应微服务的服务器上的资源路径。
此路径可用于唯一标识订单资源。 <code>{orderid}</code> 是一个变量，需要在实际 HTTP 请求中替换为<strong>适当</strong>的值。
像 <code>GET /orders/d59dbd56-6e8b-4e06-906f-59990ce2e330</code> 这样会要求微服务检索 <code>ID</code> 为 <code>d59dbd56-6e8b-4e06-906f-59990ce2e330</code> 的订单的详细信息。</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_5_理解微服务的源代码"><a class="link" href="#_1_5_理解微服务的源代码">1.5 理解微服务的源代码</a></h3>
<div class="paragraph">
<p>让我们看一下代码示例，看看如何用 Java 开发一个方法并使用 Spring Boot 将其公开为 HTTP 资源。使用操作系统中的文件浏览器打开位于 sample01/src/main/java/com/yyit/mss/ch02/sample01/service 的目录，然后在文本编辑器中打开 <code>OrderProcessingService.java</code> 文件。如果您熟悉 Eclipse、NetBeans、IntelliJ IDEA 或任何类似的 Java 集成开发环境 (IDE)，您可以将示例作为 Maven 项目导入到 IDE。以下清单显示了 <code>OrderProcessingService.java</code> 文件的内容。</p>
</div>
<div class="listingblock">
<div class="title">清单 2.1 <code>OrderProcessingService.java</code> 文件的内容</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@RestController</span> <span style="color:#777">// 通知 Spring Boot 运行时将此类公开为微服务的 Rest 资源</span>
<span style="color:#007">@RequestMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/orders</span><span style="color:#710">&quot;</span></span>) <span style="color:#777">// 指定服务所有资源所在的路径</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OrderProcessingService</span> {
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, Order&gt; orders = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;&gt;();

    <span style="color:#007">@PostMapping</span> <span style="color:#777">// 通知 Spring Boot 运行时将此方法公开为 POST HTTP 方法</span>
    <span style="color:#088;font-weight:bold">public</span> ResponseEntity&lt;Order&gt; placeOrder(<span style="color:#007">@RequestBody</span> Order order) {
        <span style="color:#0a8;font-weight:bold">System</span>.out.println(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">接收到订单 </span><span style="color:#710">&quot;</span></span>
                + order.getItems().size() + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20"> 项</span><span style="color:#710">&quot;</span></span>);
        order.getItems().forEach((lineItem) -&gt;
                <span style="color:#0a8;font-weight:bold">System</span>.out.println(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">订单项: </span><span style="color:#710">&quot;</span></span> + lineItem.getItemCode() +
                        <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20"> 数量: </span><span style="color:#710">&quot;</span></span> + lineItem.getQuantity()));
        <span style="color:#0a8;font-weight:bold">String</span> orderId = <span style="color:#0a8;font-weight:bold">UUID</span>.randomUUID().toString();
        order.setOrderId(orderId);
        orders.put(orderId, order);
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> ResponseEntity&lt;Order&gt;(order, HttpStatus.CREATED);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>这段代码是一个简单的 Java 类，带有一个名为 <code>placeOrder</code> 的函数。您可能会注意到，我们使用 <code>@RestController</code> 注解装饰了该类，以通知 Spring Boot 运行时您有兴趣将此类公开为微服务。 <code>@RequestMapping</code> 注解指定了服务的所有资源所在的路径。我们还使用 <code>@PostMapping</code> 注解修饰了 <code>placeOrder</code> 函数，它通知 Spring Boot 运行时将此函数公开为 <code>/orders</code> 上下文中的 <code>POST</code> HTTP 方法（操作）。 <code>@RequestBody</code> 注解表示 HTTP 请求中的有效负载将分配给 <code>Order</code> 类型的对象。</p>
</div>
<div class="paragraph">
<p>同一目录中的另一个文件名为 <code>OrderApplication.java</code>。使用文本编辑器打开此文件并检查其内容，如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@SpringBootApplication</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OrderApplication</span> {
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">void</span> main(<span style="color:#0a8;font-weight:bold">String</span> args<span style="color:#339;font-weight:bold">[]</span>) {
        SpringApplication.run(OrderApplication.class, args);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>这个简单的 Java 类只有 <code>main</code> 函数。 <code>@SpringBootApplication</code> 注解通知 Spring Boot 运行时这个应用程序是一个 Spring Boot 应用程序。它还对 <code>OrderApplication</code> 类的同一个包中的 <code>Controller</code> 类（例如您之前看到的 <code>OrderProcessingService</code> 类）进行运行时检查。 <code>main</code> 函数是当您命令 JVM 运行特定 Java 程序时由 JVM 调用的函数。在 <code>main</code> 函数中，通过 <code>SpringApplication</code> 类的 <code>run</code> 实用程序函数启动 Spring Boot 应用程序，该类位于 Spring 框架中。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2_设置_oauth_2_服务器"><a class="link" href="#_2_设置_oauth_2_服务器">2. 设置 OAuth 2 服务器</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>现在已经启动并运行了你的第一个微服务，我们可以开始进入主要聚焦点：保护微服务。您将使用 OAuth 2 来保护您的边缘微服务。</p>
</div>
<div class="paragraph">
<p>当与 JWT 结合使用时，OAuth 2  可以成为一种高度可扩展的身份验证和授权机制，这对于保护微服务至关重要。</p>
</div>
<div class="sect2">
<h3 id="_2_1_与授权服务器的交互"><a class="link" href="#_2_1_与授权服务器的交互">2.1 与授权服务器的交互</a></h3>
<div class="paragraph">
<p>在 OAuth 2 流程中，客户
端应用程序、最终用户和资源服务器都在不同阶段直接与授权服务器交互（见图 2）。
在从授权服务器请求令牌之前，客户端应用程序必须向它注册自己。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="doc/2.2.dio.png" alt="2.2.dio">
</div>
<div class="title">图 . 2 OAuth 2 流程中的参与者：在典型的访问委托流程中，客户端（代表最终用户）使用授权服务器提供的令牌访问托管在资源服务器上的资源</div>
</div>
<div class="paragraph">
<p>授权服务器仅为它知道的客户端应用程序颁发令牌。一些授权服务器支持动态客户端注册协议 ( <a href="https://tools.ietf.org/html/rfc7591" class="bare">https://tools.ietf.org/html/rfc7591</a> )，它允许客户端即时或按需在授权服务器上注册自己（见图 3）。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="doc/2.3.dio.png" alt="2.3.dio">
</div>
<div class="title">图 . 3 客户端应用程序向授权服务器请求访问令牌。授权服务器只向已知的客户端应用程序颁发令牌。客户端应用程序必须首先在授权服务器上注册。</div>
</div>
<div class="paragraph">
<p>Order Processing 微服务在这里扮演了<strong>资源服务器</strong>的角色，它会从客户端接收授权服务器发出的令牌，通常作为 HTTP 请求头或客户端发出 HTTP 请求时的查询参数（参见第 1 步）图 4)。<em>建议客户端通过 HTTPS 与微服务通信</em>，并在 HTTP header 而不是查询参数中发送令牌。因为查询参数是在 URL 中发送的，所以这些参数可以记录在服务器日志中。因此，任何有权访问日志的人都可以看到此信息。</p>
</div>
<div class="paragraph">
<p>使用 TLS 来保护 OAuth 2 流中所有实体之间的通信（或换句话说，使用 HTTPS）非常重要。
授权服务器为访问微服务（或资源）而颁发的令牌（访问令牌）必须像密码一样受到保护。
我们不会通过纯 HTTP 发送密码，而是始终使用 HTTPS。
因此，我们在通过网络发送访问令牌时遵循相同的过程。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="doc/2.4.dio.png" alt="2.4.dio">
</div>
<div class="title">图 . 4 客户端应用程序在 HTTP 授权请求头中传递 OAuth 访问令牌以从资源服务器访问资源。</div>
</div>
<div class="paragraph">
<p>收到访问令牌后，订单处理微服务应在授予对其资源的访问权限之前根据授权服务器对其进行验证。
OAuth 2 授权服务器通常支持 OAuth 2 令牌自省配置文件 (<a href="https://tools.ietf.org/html/rfc7662" class="bare">https://tools.ietf.org/html/rfc7662</a>) 或资源服务器的类似替代方案，
以检查访问令牌的有效性（见图 5）。
如果访问令牌是自包含的 JWT，资源服务器可以自行验证它，而无需与授权服务器交谈。我们将在后面详细讨论自包含的 JWT。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="doc/2.5.dio.png" alt="2.5.dio">
</div>
<div class="title">图 . 5 订单处理微服务（资源服务器）通过与授权服务器对话来内省访问令牌。</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_2_运行_oauth_2_授权服务器"><a class="link" href="#_2_2_运行_oauth_2_授权服务器">2.2 运行 OAuth 2 授权服务器</a></h3>
<div class="paragraph">
<p>许多生产级 OAuth 2.0 授权服务器都在那里，既有专有的，也有开源的。
然而，在本章中，我们使用一个能够发布访问令牌的简单授权服务器。
它是使用 Spring Boot 构建的。在之前克隆的 Git 源码库中，您应该会在目录 lesson02 下找到一个名为 sample02 的目录。
您将在那里找到简单 OAuth 2 授权服务器的源代码。首先，编译并运行它；然后查看代码以了解它的作用。</p>
</div>
<div class="paragraph">
<p>要编译，使用命令行客户端导航到 lesson02/sample02 目录。从该目录中，执行以下 Maven 命令以编译和构建可运行 artifact：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean install</pre>
</div>
</div>
<div class="paragraph">
<p>如果您的构建成功，您将看到消息 BUILD SUCCESS。您应该在名为 target 的目录中找到名为 com.yyit.mss.ch02.sample02-1.0.jar 的文件。从lesson02/sample02 目录中使用命令行客户端执行以下命令，以运行OAuth 2.0 授权服务器：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn spring-boot:run</pre>
</div>
</div>
<div class="paragraph">
<p>如果成功运行服务器，应该看到以下消息：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Started OAuthServerApplication in &lt;X&gt; seconds</pre>
</div>
</div>
<div class="paragraph">
<p>此消息表明您已成功启动授权服务器。默认情况下，OAuth 2.0 授权服务器在 HTTP 端口 8085 上运行。如果您的本地机器上有任何其他服务在 8085 端口上运行，请确保停止它们；或者，您可以通过在 lesson02/sample02/src/main/resources/application.properties 文件中适当地更改 server.port 属性的值来更改授权服务器的默认端口。</p>
</div>
</div>
<div class="sect2">
<h3 id="_2_3_从_oauth_2_授权服务器获取访问令牌"><a class="link" href="#_2_3_从_oauth_2_授权服务器获取访问令牌">2.3 从 OAuth 2 授权服务器获取访问令牌</a></h3>
<div class="paragraph">
<p>要从授权服务器获取访问令牌，请使用 HTTP 客户端向服务器发出 HTTP 请求。在现实世界中，访问微服务的客户端应用程序会发出此请求。为此，您将使用 curl 作为 HTTP 客户端。要从授权服务器（在端口 8085 上运行）请求访问令牌，请使用命令行客户端运行以下命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl  -u &quot;orderprocessingapp:orderprocessingsecret&quot; \
-H &quot;Content-Type: application/x-www-form-urlencoded&quot; \
-d 'grant_type=client_credentials'  \
-X POST http://localhost:8085/oauth2/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果您的请求成功，您应该会看到类似于以下内容的响应：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span style="color:#606"><span style="color:#404">&quot;</span><span>access_token</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">eyJraWQiOiJhOTQ5ODkyNC1kODE1LTRlZmItODlmYS1lYmFkMmFkOTU4OGMiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJ5eWl0IiwiYXVkIjoieXlpdCIsIm5iZiI6MTY1MTExNzE2MCwic2NvcGUiOlsib3BlbmlkIiwib3JkZXJzIl0sImlzcyI6Imh0dHA6XC9cL2xvY2FsaG9zdDo5MDAwIiwiZXhwIjoxNjUxMTE3NDYwLCJpYXQiOjE2NTExMTcxNjB9.SboppQgJ57rKCiq2sIivOeOKxNJoYjEZ-YXFjeLAE1x80cPLBAwf106YuUsZJNyxW_3uEn0K7JNIT7DWg3mVdhIHe5XOAD7W6nRR3DP_e3WXlXwugaNxDIInXBCFqTPleVldeSXEjMMpSGrsDnaIClAV1D9c0vrfZCtrUT0CvUO_tgMWtpQyCXGHLeeDsDYtasxXvgsocnozfoNpQyxvBdARtsqZEmBIErDPP-gr7FN_KETqiUfQ_CZMjVYV-992SNW-l7kOxdI03LhLygQ6CBiQWkCehQu1YMGgroiMVS6x1-yeT1A2LpClnnr2HsUbZAa9BDEMUzLqjDVZXCopqQ</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>scope</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">openid orders</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>token_type</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Bearer</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>expires_in</span><span style="color:#404">&quot;</span></span>:<span style="color:#00D">300</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>快速浏览一下这个请求并尝试理解它。
您可以将 <code>orderprocessingapp:orderprocessingsecret</code> 视为客户端应用程序的用户名 (orderprocessingapp) 和密码 (orderprocessingsecret)。唯一的区别是这些凭证属于应用程序，而不是用户。用于请求令牌的应用程序需要携带唯一标识符和授权服务器已知的密钥。提供给 <code>curl</code> 的 <code>-u</code> 标志指示它创建一个基本的身份验证请求头并将其作为 HTTP 请求的一部分发送到授权服务器。
然后 curl base64 编码 <code>orderprocessingapp:orderprocessingsecret</code> 字符串并创建基本身份验证 HTTP 请求头，如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Authorization: Basic b3JkZXJwcm9jZXNzaW5nYXBwOm9yZGVycHJvY2Vzc2luZ3NlY3JldA==</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basic 关键字后面的字符串是 <code>orderprocessingapp:orderprocessingsecret</code> 的 base64 编码值。
您可能已经注意到，您正在向 OAuth 2  授权服务器的令牌端点发送基本身份验证请求头，因为令牌端点受基本身份验证 (<a href="https://tools.ietf.org/html/rfc2617" class="bare">https://tools.ietf.org/html/rfc2617</a>) 保护。
由于客户端应用程序在此处请求令牌，因此基本身份验证请求头应包含客户端应用程序的凭据，而不是用户的凭据。
请注意，这里的基本身份验证不用于保护资源服务器（或微服务）；
您为此目的使用 OAuth 2。此时的基本身份验证仅用于从授权服务器获取访问微服务所需的 OAuth 令牌。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl  -H &quot;Authorization: Basic b3JkZXJwcm9jZXNzaW5nYXBwOm9yZGVycHJvY2Vzc2luZ3NlY3JldA==&quot; \
-H &quot;Content-Type: application/x-www-form-urlencoded&quot; \
-d 'grant_type=client_credentials'  \
-X POST http://localhost:8085/oauth2/token</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_4_理解访问令牌响应"><a class="link" href="#_2_4_理解访问令牌响应">2.4 理解访问令牌响应</a></h3>
<div class="paragraph">
<p>以下列表提供了有关来自授权服务器的上述 JSON 响应的详细信息。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>access_token</em> — 授权服务器向客户端应用程序颁发的令牌值（在本例中为 curl）。</p>
</li>
<li>
<p><em>token_type</em> — 令牌类型（当我们在附录 A 中讨论 OAuth 2 时将详细介绍此主题）。我们今天看到的大多数 OAuth 部署都使用不记名令牌。</p>
</li>
<li>
<p><em>expires_in</em> — 令牌的有效期，以秒为单位。在此期间之后，令牌将被视为无效（过期）。</p>
</li>
<li>
<p><em>scope</em> — 允许令牌在资源服务器（微服务）上执行的操作。</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_使用_oauth_2_保护微服务"><a class="link" href="#_3_使用_oauth_2_保护微服务">3 使用 OAuth 2 保护微服务</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>到目前为止，您已经学习了如何开发您的第一个微服务以及如何设置 OAuth 2 授权服务器以获取访问令牌。在本节中，您将看到如何保护您开发的微服务。到目前为止，您已经在没有任何安全措施的情况下访问了它。</p>
</div>
<div class="sect2">
<h3 id="_3_1_基于_oauth_2_的保护"><a class="link" href="#_3_1_基于_oauth_2_的保护">3.1 基于 OAuth 2 的保护</a></h3>
<div class="paragraph">
<p>使用 OAuth 2 进行保护后，订单处理微服务现在需要来自调用客户端应用程序的有效安全令牌（访问令牌）。
然后，它会在授权服务器的帮助下验证此访问令牌，然后再授予对其资源的访问权限。图 6 说明了这种情况。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="doc/2.6.dio.png" alt="2.6.dio">
</div>
<div class="title">图 . 6 客户端应用程序使用从授权服务器获取的访问令牌访问安全微服务。 Order Processing 微服务在授予对其资源的访问权限之前与授权服务器对话以验证令牌。</div>
</div>
<div class="paragraph">
<p>以下是图 6 所示的每个步骤中发生的情况：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>客户端应用程序从授权服务器请求 OAuth 2 访问令牌。</p>
</li>
<li>
<p>响应步骤 1 中的请求，授权服务器向客户端应用程序发出访问令牌。</p>
</li>
<li>
<p>客户端应用程序向订单处理微服务发出 HTTP 请求。此请求携带在步骤 2 中获取的访问令牌作为 HTTP 请求头。</p>
</li>
<li>
<p>Order Processing 微服务与授权服务器一起检查接收到的访问令牌是否有效。</p>
</li>
<li>
<p>响应步骤 4 中的请求，授权服务器检查提供的访问令牌是否是系统中的活动令牌（其状态为活动）以及该令牌在该特定时刻是否有效（未过期） .然后它响应 Order Processing 微服务，指示访问令牌是否有效。</p>
</li>
<li>
<p>响应第 3 步中的请求，并根据第 5 步中的结果，订单处理微服务响应客户端应用程序，要么授予对所请求资源的访问权限，要么发送错误消息。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>已经使用 client_credentials 授权类型从授权服务器获取访问令牌。
在这种特殊情况下，授权服务器的令牌端点通过使用 client ID 和应用程序的 client secret 进行基本身份验证来保护。
当客户端应用程序不需要担心最终用户时，client_credentials 授予类型很好。
如果必须，它应该选择合适的授权类型。
<strong><em>client_credentials 授权类型主要用于系统到系统的身份验证</em></strong>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_3_2_运行示例"><a class="link" href="#_3_2_运行示例">3.2 运行示例</a></h3>
<div class="paragraph">
<p>导航到你从命令行应用程序从 Git 仓库克隆示例的目录，然后转到 lesson02/sample03 目录。从该目录中，执行以下 Maven 命令以构建示例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn clean install</pre>
</div>
</div>
<div class="paragraph">
<p>如果构建成功，您应该在当前目录中看到一个名为 target 的目录。target 目录应包含名为 com.yyit.mss.ch02.sample03-1.0.jar 的文件。
然后从 lesson02/sample03/ 目录运行以下命令以启动安全的订单处理微服务。在这里，我们使用了一个名为 spring-boot 的 Maven 插件：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn spring-boot:run</pre>
</div>
</div>
<div class="paragraph">
<p>如果您成功运行服务器，您应该看到如下消息：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Started OrderApplication in &lt;X&gt; seconds</pre>
</div>
</div>
<div class="paragraph">
<p>现在运行前面使用的相同 curl 命令来访问订单处理微服务：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>curl -v http://localhost:8080/orders \
-H 'Content-Type: application/json' \
--data-binary @- &lt;&lt; EOF
{
  &quot;items&quot;:[
    {
      &quot;itemCode&quot;:&quot;IT0001&quot;,
      &quot;quantity&quot;:3
    },
    {
      &quot;itemCode&quot;:&quot;IT0004&quot;,
      &quot;quantity&quot;:1
    }
  ],
  &quot;shippingAddress&quot;:&quot;福建省厦门市XX区XX街道XX小区XX栋XX室&quot;
}
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>您应该会看到一条错误消息，指出请求不成功。预期的响应消息如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>HTTP/1.1 401</pre>
</div>
</div>
<div class="paragraph">
<p>您的订单处理微服务现已受到保护，如果没有从授权服务器获取的有效访问令牌，则无法再访问。
要了解这是如何发生的，请查看订单处理微服务的修改后的源代码。
使用您喜欢的文本编辑器或 IDE，打开位于 src/main/java/com/yyit/mss/ch02/sample03/configuration 目录中的 SpringSecurityConfiguration.java 文件。
这个类的一个补充是注解 @EnableWebSecurity。此注解通知您的 Spring Boot 运行时将保护应用于此微服务的资源。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_从客户端应用程序调用安全的微服务"><a class="link" href="#_4_从客户端应用程序调用安全的微服务">4 从客户端应用程序调用安全的微服务</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>在客户端应用程序可以访问您的安全订单处理微服务之前，它应该从授权服务器获取 OAuth2.0 访问令牌。
如前面所述，客户端应用程序至少需要有效的 Client ID 和 Client Secret 才能获取此令牌。
目前在您的 OAuth 2.0 授权服务器上注册的 Client ID 和 Client Secret 分别是 <code>orderprocessingservice</code> 和 <code>orderprocessingservicesecret</code>。
和前面一样，您可以使用以下 curl 命令来获取访问令牌：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl  -H &quot;Authorization: Basic b3JkZXJwcm9jZXNzaW5nYXBwOm9yZGVycHJvY2Vzc2luZ3NlY3JldA==&quot; \
-H &quot;Content-Type: application/x-www-form-urlencoded&quot; \
-d 'grant_type=client_credentials'  \
-X POST http://localhost:8085/oauth2/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果请求成功，您应该得到一个访问令牌作为响应，如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span style="color:#606"><span style="color:#404">&quot;</span><span>access_token</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">eyJraWQiOiI0MTU1MTQ2OC0zNjUyLTQ4ZTktYjNlMy04OTYyYTRiYTAzZDUiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJvcmRlcnByb2Nlc3NpbmdzZXJ2aWNlIiwiYXVkIjoib3JkZXJwcm9jZXNzaW5nc2VydmljZSIsIm5iZiI6MTY1MTEyOTI5MCwic2NvcGUiOlsicmVhZCIsIm9wZW5pZCIsIndyaXRlIl0sImlzcyI6Imh0dHA6XC9cL2xvY2FsaG9zdDo4MDg1IiwiZXhwIjoxNjUxMTI5NTkwLCJpYXQiOjE2NTExMjkyOTB9.eZ2Jkwzo10qTVeMPCaJHcQy329bXky1rRcVpQlY6mzqp0EnlGac86CGp2Fz_P1GxYCrvzpqUgO2B26IMd4n2y9D1j-c3wqyndDAw7DdK673YBCpS-7_9Ovgb1q9kON0uvlLGPT4cO91_F0W2Tj6Ar6XyhiZKRmfblEYAKbNhh14-LC8l4dSwEwWtr7JzTTSmEjuFUoD955QBN3uDz3fHXW4TyRgs9zc59MEEXBCqyRETNJIOxRaRPlU-XGryHX8ntKp7UkrwbNRPLo93GUACZ9MMGTaltstbjsCnFmsULXXwam7g3cXm6HY0bqH9bWdJfYSfqkfj4diaHb_XZML7BQ</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>scope</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">read openid write</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>token_type</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Bearer</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>expires_in</span><span style="color:#404">&quot;</span></span>:<span style="color:#00D">299</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>如前所述，<code>eyJraWQiOiI0MTU1MTQ2OC0zNjUyLTQ4ZTktYjNlMy04OTYyYTRiYTAzZDUiLCJhbGciOiJSUzI1NiJ9&#8230;&#8203;</code> 是您获得的访问令牌的值，其有效期为将近 5 分钟（299 秒）。
需要将此访问令牌提供给您将向订单处理微服务发出的 HTTP 请求。
您需要将令牌作为名为 Authorization 的 HTTP 请求头发送，
并且请求头值需要以字符串 Bearer 为前缀，如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Authorization: Bearer  eyJraWQiOiI0MTU1MTQ2OC0zNjUyLTQ4ZTktYjNlMy04OTYyYTRiYTAzZDUiLCJhbGciOiJSUzI1NiJ9...</pre>
</div>
</div>
<div class="paragraph">
<p>访问订单处理微服务的新 curl 命令如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -v http://localhost:8080/orders \
-H 'Authorization: Bearer eyJraWQiOiI0MTU1MTQ2OC0zNjUyLTQ4ZTktYjNlMy04OTYyYTRiYTAzZDUiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJvcmRlcnByb2Nlc3NpbmdzZXJ2aWNlIiwiYXVkIjoib3JkZXJwcm9jZXNzaW5nc2VydmljZSIsIm5iZiI6MTY1MTEyOTI5MCwic2NvcGUiOlsicmVhZCIsIm9wZW5pZCIsIndyaXRlIl0sImlzcyI6Imh0dHA6XC9cL2xvY2FsaG9zdDo4MDg1IiwiZXhwIjoxNjUxMTI5NTkwLCJpYXQiOjE2NTExMjkyOTB9.eZ2Jkwzo10qTVeMPCaJHcQy329bXky1rRcVpQlY6mzqp0EnlGac86CGp2Fz_P1GxYCrvzpqUgO2B26IMd4n2y9D1j-c3wqyndDAw7DdK673YBCpS-7_9Ovgb1q9kON0uvlLGPT4cO91_F0W2Tj6Ar6XyhiZKRmfblEYAKbNhh14-LC8l4dSwEwWtr7JzTTSmEjuFUoD955QBN3uDz3fHXW4TyRgs9zc59MEEXBCqyRETNJIOxRaRPlU-XGryHX8ntKp7UkrwbNRPLo93GUACZ9MMGTaltstbjsCnFmsULXXwam7g3cXm6HY0bqH9bWdJfYSfqkfj4diaHb_XZML7BQ'
-H 'Content-Type: application/json' \
--data-binary @- &lt;&lt; EOF
{
  &quot;items&quot;:[
    {
      &quot;itemCode&quot;:&quot;IT0001&quot;,
      &quot;quantity&quot;:3
    },
    {
      &quot;itemCode&quot;:&quot;IT0004&quot;,
      &quot;quantity&quot;:1
    }
  ],
  &quot;shippingAddress&quot;:&quot;福建省厦门市XX区XX街道XX小区XX栋XX室&quot;
}
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>请注意，<code>-H</code> 参数用于将访问令牌作为名为 Authorization 的 HTTP 请求头传递。
这一次，您应该看到订单处理微服务响应一条正确的消息，说明订单成功：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span style="color:#606"><span style="color:#404">&quot;</span><span>orderId</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">481cd245-df48-4088-ba6c-e2daeac69b6c</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>items</span><span style="color:#404">&quot;</span></span>:[
    {<span style="color:#606"><span style="color:#404">&quot;</span><span>itemCode</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">IT0001</span><span style="color:#710">&quot;</span></span>,<span style="color:#606"><span style="color:#404">&quot;</span><span>quantity</span><span style="color:#404">&quot;</span></span>:<span style="color:#00D">3</span>},
    {<span style="color:#606"><span style="color:#404">&quot;</span><span>itemCode</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">IT0004</span><span style="color:#710">&quot;</span></span>,<span style="color:#606"><span style="color:#404">&quot;</span><span>quantity</span><span style="color:#404">&quot;</span></span>:<span style="color:#00D">1</span>}
  ],
  <span style="color:#606"><span style="color:#404">&quot;</span><span>shippingAddress</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">福建省厦门市XX区XX街道XX小区XX栋XX室</span><span style="color:#710">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果您看到此消息，则您已成功创建、部署和测试了安全的微服务。
恭喜！客户端应用程序 (curl) 在 HTTP 请求头中发送到订单处理微服务的访问令牌已根据授权服务器进行验证。
这个过程称为令牌自省。
由于内省操作的结果最终成功，订单处理微服务授予对其资源的访问权限。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_使用_oauth_2_scope_执行服务级别授权"><a class="link" href="#_5_使用_oauth_2_scope_执行服务级别授权">5 使用 OAuth 2 scope 执行服务级别授权</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>需要有效的访问令牌才能访问微服务。身份验证是应用于微服务以防止其受到欺骗的第一级防御。
在授予对微服务的访问权限之前发生的身份验证步骤可确保调用实体是系统中的有效客户端（用户、应用程序或两者）。
然而，身份验证并未提及客户端在系统中拥有的权限级别。</p>
</div>
<div class="paragraph">
<p>一个给定的微服务可能有多个操作。
例如，订单处理微服务有一个用于创建订单的操作 (<code>POST /orders</code>) 和另一个用于检索订单详细信息的操作 (<code>GET /orders/{id}</code>)。
微服务中的每个操作可能需要不同级别的访问权限。</p>
</div>
<div class="paragraph">
<p>privilege 描述了您被允许对资源执行的操作。通常，您在组织中的一个或多个角色描述了您在该组织内可以执行的操作以及您不可以执行的操作。privilege 还可以表明地位或可信度。如果您乘坐过商业航空公司，您可能熟悉属于航空公司飞行常客计划的旅客的会员身份。同样，privilege 是用户或应用程序在系统中拥有的访问级别的指示。</p>
</div>
<div class="paragraph">
<p>在 OAuth 2.0 的世界中，privilege 被映射到一个 scope。scope 是抽象 privilege 的方式。
privilege 可以是用户的角色、成员身份、可信度或其他内容。它也可以是几个这样的属性的组合。
您使用 scope 来抽象 privilege 的含义。
scope 声明调用客户端应用程序授予对资源的访问权限所需的 privilege。
例如，placeOrder 操作需要一个称为 write 的 scope，而 getOrder 操作需要一个称为 read 的 scope。</p>
</div>
<div class="sect2">
<h3 id="_5_1_从授权服务器获取作用域访问令牌"><a class="link" href="#_5_1_从授权服务器获取作用域访问令牌">5.1 从授权服务器获取作用域访问令牌</a></h3>
<div class="paragraph">
<p>您在本章中构建的授权服务器包含两个应用程序：一个带有 Client ID <code>orderprocessingapp</code>，用于访问微服务，
另一个带有 Client ID <code>orderprocessingservice</code>。
您以这样一种方式配置这些应用程序，即具有 Client ID <code>orderprocessingapp</code> 的第一个应用程序有权获得读取和写入 scope，而具有 Client ID <code>orderprocessingservice</code> 的第二个应用程序仅有权获得读取 scope，如以下列表：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"> <span style="color:#007">@Bean</span>
    <span style="color:#088;font-weight:bold">public</span> RegisteredClientRepository registeredClientRepository(PasswordEncoder encoder) {
        RegisteredClient registeredClient = RegisteredClient.withId(<span style="color:#0a8;font-weight:bold">UUID</span>.randomUUID().toString())
                .clientId(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">orderprocessingapp</span><span style="color:#710">&quot;</span></span>)
                .clientSecret(encoder.encode(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">orderprocessingsecret</span><span style="color:#710">&quot;</span></span>))
                .clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_POST)
                .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)
                .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)
                .authorizationGrantType(AuthorizationGrantType.REFRESH_TOKEN)
                .redirectUri(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">https://oidcdebugger.com/debug</span><span style="color:#710">&quot;</span></span>)
                .redirectUri(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">https://www.baidu.com</span><span style="color:#710">&quot;</span></span>)
                .scope(OidcScopes.OPENID)
                .scope(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">read</span><span style="color:#710">&quot;</span></span>)
                .scope(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">write</span><span style="color:#710">&quot;</span></span>)
                .build();

        RegisteredClient registeredClient1 = RegisteredClient.withId(<span style="color:#0a8;font-weight:bold">UUID</span>.randomUUID().toString())
                .clientId(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">orderprocessingservice</span><span style="color:#710">&quot;</span></span>)
                .clientSecret(encoder.encode(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">orderprocessingservicesecret</span><span style="color:#710">&quot;</span></span>))
                .clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_BASIC)
                .clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_POST)
                .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)
                .redirectUri(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">https://oidcdebugger.com/debug</span><span style="color:#710">&quot;</span></span>)
                .redirectUri(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">https://www.baidu.com</span><span style="color:#710">&quot;</span></span>)
                .scope(OidcScopes.OPENID)
                .scope(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">read</span><span style="color:#710">&quot;</span></span>)
                .build();
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> InMemoryRegisteredClientRepository(registeredClient,registeredClient1);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>此代码表明，任何使用 <code>orderprocessingapp</code> 的人都可以在 <code>read</code> 和 <code>write</code> scope 内获取访问令牌，而任何使用 <code>orderprocessingservice</code> 的用户只能在 <code>read</code> scope 内获取访问令牌。
在迄今为止获取访问令牌的所有请求中，您使用 <code>orderprocessingapp</code> 作为 Client ID 并请求了 read 和 write 两个 scope。</p>
</div>
<div class="paragraph">
<p>现在执行相同的请求以获取一个以 <code>orderprocessingservice</code> 作为 Client ID 的访问令牌，以查看令牌响应是什么样的。执行此 curl 命令以发出令牌请求：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl  -u &quot;orderprocessingservice:orderprocessingservicesecret&quot; \
-H &quot;Content-Type: application/x-www-form-urlencoded&quot; \
-d 'grant_type=client_credentials'  \
-X POST http://localhost:8085/oauth2/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果令牌请求成功，您应该会看到以下响应：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span style="color:#606"><span style="color:#404">&quot;</span><span>access_token</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">eyJraWQiOiIyNzlkNzM5Zi1mNjIzLTRjMDEtOTFmYi00NTVmZThjMzFiZTIiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJvcmRlcnByb2Nlc3NpbmdzZXJ2aWNlIiwiYXVkIjoib3JkZXJwcm9jZXNzaW5nc2VydmljZSIsIm5iZiI6MTY1MTEzMDQ5Nywic2NvcGUiOlsicmVhZCIsIm9wZW5pZCJdLCJpc3MiOiJodHRwOlwvXC9sb2NhbGhvc3Q6ODA4NSIsImV4cCI6MTY1MTEzMDc5NywiaWF0IjoxNjUxMTMwNDk3fQ.ifh0XrokV_mueOddSq-3dZpcrAkbrZsgFFE9A7l9oIrYbudEXxgeKt71MyNLe7vkS_TO1HijOusTxoqhQH-CbsXmz_44rOPinSYLXLQJhlXLG7YGisePchbwr4MdR_j7PbtpVtaKPpGF8_y5WKLDdXbYhwZZ2cSDhVBljGKhjimakeKRb8FvpAATasdOdxSCFRB_9d2e6phoSKMOSUHRvLEcv__UIWvaBzmaDV1D241Tblziw8SFNWpDdb0HXEIDCec-aktPEyxd2qPweEW5G-fTtrAb7bbSY5yI8Mlax7z0q1XGPHNuuobG6r1GvtB5x2iaS-MuzpRZSWLa-t1ajQ</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>scope</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">read openid</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>token_type</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Bearer</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>expires_in</span><span style="color:#404">&quot;</span></span>:<span style="color:#00D">299</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_使用_oauth_2_0_scope_保护对微服务的访问"><a class="link" href="#_5_2_使用_oauth_2_0_scope_保护对微服务的访问">5.2 使用 OAuth 2.0 scope 保护对微服务的访问</a></h3>
<div class="paragraph">
<p>现在您已经了解授权服务器如何根据 scope 向令牌授予权限。
您将看到资源服务器或微服务如何对其想要保护的资源实施这些 scope。
以下清单（lesson02/sample03/src/main/java/com/yyit/mss/ch02/sample03/configuration/SpringSecurityConfiguration.java 类文件）解释了资源服务器如何执行这些规则。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@EnableWebSecurity</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">SpringSecurityConfiguration</span> <span style="color:#088;font-weight:bold">extends</span> WebSecurityConfigurerAdapter {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> SECURED_READ_SCOPE = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">SCOPE_read</span><span style="color:#710">&quot;</span></span>;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> SECURED_WRITE_SCOPE = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">SCOPE_write</span><span style="color:#710">&quot;</span></span>;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> SECURED_PATTERN_WRITE = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/orders/**</span><span style="color:#710">&quot;</span></span>;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> SECURED_PATTERN_READ = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/orders/{id}</span><span style="color:#710">&quot;</span></span>;

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">protected</span> <span style="color:#339;font-weight:bold">void</span> configure(HttpSecurity http) <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">Exception</span> {
        <span style="color:#777">// @formatter:off</span>
        http.authorizeRequests()
                .antMatchers(SECURED_PATTERN_WRITE).hasAuthority(SECURED_WRITE_SCOPE)
                .antMatchers(SECURED_PATTERN_READ).hasAuthority(SECURED_READ_SCOPE)
                .anyRequest().authenticated()
                .and()
                .oauth2ResourceServer().jwt();
        <span style="color:#777">// @formatter:on</span>
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>如您所见，该代码指示微服务运行时 (Spring Boot) 检查特定 HTTP 方法和请求路径的相关 scope。这行代码</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">.antMatchers(SECURED_PATTERN_WRITE).hasAuthority(SECURED_WRITE_SCOPE)</code></pre>
</div>
</div>
<div class="paragraph">
<p>检查针对与正则表达式 <code>/orders/**</code> 匹配的请求路径发出的任何请求的 scope write。类似地，这行代码检查在路径 <code>/orders/{id}</code> 上为请求 read 的 scope：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">.antMatchers(SECURED_PATTERN_READ).hasAuthority(SECURED_READ_SCOPE)</code></pre>
</div>
</div>
<div class="paragraph">
<p>现在尝试使用只有 <code>read</code> scope 的令牌访问 POST /orders 资源。执行您上次使用的相同 curl 命令来访问此资源，但这次使用不同的令牌（仅具有读取访问权限的令牌）：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -v http://localhost:8080/orders \
-H 'Authorization: Bearer eyJraWQiOiIyNzlkNzM5Zi1mNjIzLTRjMDEtOTFmYi00NTVmZThjMzFiZTIiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJvcmRlcnByb2Nlc3NpbmdzZXJ2aWNlIiwiYXVkIjoib3JkZXJwcm9jZXNzaW5nc2VydmljZSIsIm5iZiI6MTY1MTEzMDg2NCwic2NvcGUiOlsicmVhZCIsIm9wZW5pZCJdLCJpc3MiOiJodHRwOlwvXC9sb2NhbGhvc3Q6ODA4NSIsImV4cCI6MTY1MTEzMTE2NCwiaWF0IjoxNjUxMTMwODY0fQ.EjUNRVaXQHiqWNFbi0Vbi13HMVo9zjVNcA8TlxpVCRwS9it43RiKxrctZeYGozuFqQGTDq9K3ikQGMeZAnj0iPM2G7n8xkBEj-JPc7ORY8ywkMKta52I_osRK3-_CZVnukaNniv6oD5UKHHQ5iLI0fO-k5sa-Qj8Mc1vsOBQTgj9fhv86r3BXsL8nXtdKwD9HBNDQJgbIPzZhoF4vmOf4TnolWz3b-fqnEUqLaj7WHJUkxZW6ZDrsrxIe3T8cNhr76Xf8PpoWu_amw5FJ9acgsuRIAoWqTgabVPonQyUQFuKxBWOA-KBOcYsfADBVAQ5zu-LzaLJFBSqknylPaqBmw' \
-H 'Content-Type: application/json' \
--data-binary @- &lt;&lt; EOF
{
  &quot;items&quot;:[
    {
      &quot;itemCode&quot;:&quot;IT0001&quot;,
      &quot;quantity&quot;:3
    },
    {
      &quot;itemCode&quot;:&quot;IT0004&quot;,
      &quot;quantity&quot;:1
    }
  ],
  &quot;shippingAddress&quot;:&quot;福建省厦门市XX区XX街道XX小区XX栋XX室&quot;
}
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>执行此命令时，应该会看到来自资源服务器的此错误响应：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt; HTTP/1.1 403
&lt; WWW-Authenticate: Bearer error=&quot;insufficient_scope&quot;, error_description=&quot;The request requires higher privileges than provided by the access token.&quot;, error_uri=&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>此响应表示此特定操作的令牌 scope 不足，所需 scope 为 <code>write</code>。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_总结"><a class="link" href="#_总结">总结</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OAuth 2 是一种授权框架，广泛用于保护边缘微服务部署。</p>
</li>
<li>
<p>OAuth 2 支持多种授权类型。我们在本章中使用的客户端凭据授权类型主要用于系统到系统的身份验证。</p>
</li>
<li>
<p>授权服务器发出的每个访问令牌都与一个或多个 scope 耦合。 OAuth 2 中使用 scope 来表达附加到访问令牌的权限。</p>
</li>
<li>
<p>OAuth 2 scope 用于保护和强制执行微服务中某些操作中的访问控制检查。</p>
</li>
<li>
<p>当前所有示例都使用 HTTP（而不是 HTTPS）端点来使您不必设置正确的证书，并使您可以在需要时检查线路（网络）上传递的消息。在生产系统中，我们不建议对任何端点使用 HTTP。</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-06-27 11:45:02 +0800
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>