= 微服务安全第三课(使用 API 网关保护北/南流量)
:author: yyit
:stem: latexmath
:icons: font
:source-highlighter: coderay
:sectlinks:
:sectnumlevels: 4
:toc: left
:toc-title: 目录
:toclevels: 3

在第 2 课中，我们讨论了如何使用 OAuth 2 在边缘保护微服务。第 2 课的重点是通过简单的部署开始工作。
第 2 课中的示例远未准备好生产。每个微服务都必须连接到 OAuth 2 授权服务器以进行令牌验证，并决定它想要信任哪个 OAuth 2 授权服务器。
当您拥有数百个微服务并且微服务开发人员承担过多责任时，这不是一个可扩展的模型。

在理想的世界中，微服务开发人员应该只关心微服务的业务功能，其余的应该由专门的组件处理，麻烦更少。
API 网关和服务网格是帮助我们实现这一理想的两种架构模式。在本章中，我们将讨论 API 网关模式，并在后面讨论服务网格模式。
API 网关模式主要是关于边缘安全，而服务网格模式处理服务到服务的安全。
或者，换句话说，_API Gateway 处理北/南流量，而 Service Mesh 处理东/西流量_。
我们将实现 API 网关模式的软件称为 API 网关，而将实现服务网格模式的软件称为服务网格。

边缘安全是关于在 API 网关的部署入口点保护一组资源（例如，一组微服务）。
API 网关是我们微服务部署的唯一入口点，用于处理来自外部的请求。在服务网格模式中，架构更加分散。
每个微服务都有自己的策略执行点，离服务更近——大多数情况下它是一个 proxy，运行在每个微服务旁边。
API 网关是整个微服务部署的集中策略执行点，而在服务网格中，与每个微服务一起运行的代理在服务级别提供另一个级别的策略执行。
在后续课程，我们将讨论如何利用本课中讨论的 API 网关模式以及服务网格模式来构建端到端的安全解决方案。


== 1 微服务部署中对 API 网关的需求

在微服务部署中拥有 API 网关很重要。 API 网关是我们架构中的重要基础设施，因为它起着关键作用，可以帮助我们清楚地将功能性需求与非功能性需求区分开来。
我们将扩展第 2 课的用例（一家零售店），查看其中的一些问题，并解释如何使用 API 网关模式解决这些问题。

在典型的微服务部署中，微服务不会直接暴露给客户端应用程序。
在大多数情况下，微服务位于一组通过 API 网关向外界公开的 API 之后。
API 网关是微服务部署的入口点，它会筛选所有传入消息以确保安全性和其他 QoS 功能。

图 1 描绘了一个典型微服务部署，其中所有微服务都以 Spring Cloud Gateway API 网关为前端。
Spring Cloud Gateway 提供动态路由、监控、弹性、安全性等。它充当服务器基础设施的前门，处理来自世界各地用户的流量。
在图 1 中，Spring Cloud Gateway 用于通过 API 公开订单处理微服务。
我们不会从 API 网关公开库存和物流微服务，因为外部应用程序不需要访问这些微服务。

.1 带有 API 网关的典型微服务部署。 API 网关筛选所有传入消息的安全性和其他服务质量特性。
[caption="图 . "]
image::doc/3.1.dio.png[]

=== 1.1 安全与微服务解耦

微服务最佳实践的一个关键方面是单一职责原则。
这个在编程中常用的原则表明，每个模块、类或函数都应该负责软件功能的一个部分。
在这个原则下，每个微服务应该只执行一个特定的功能。

在第 2 课的示例中，安全订单处理微服务的实现方式是，除了处理订单的核心业务功能外，它还必须与授权服务器通信并验证从客户端应用程序获得的访问令牌。
如图 2 所示，订单处理微服务不得不担负这里列出的多个任务：

- 从传入的请求中提取安全请求头（token）
- 事先知道授权服务器的位置，它必须与之交互以验证安全 token
- 了解与授权服务器通信的协议和消息格式，以验证安全 token
- 优雅地处理 token 验证流程中的错误，因为微服务直接暴露给客户端应用程序
- 执行与处理订单相关的业务逻辑

.2 客户端应用程序、微服务和授权服务器之间的交互。订单处理微服务处理的功能比理想情况下要多。
[caption="图 . "]
image::doc/3.2.dio.png[]

执行所有这些步骤会成为一个问题，因为微服务通过执行比预期更多的操作而失去了它的原子特性。
微服务最好只执行前面列表中的第五项任务，这是处理我们设计微服务所针对的业务逻辑的任务。
安全和业务逻辑的耦合给微服务带来了不必要的复杂性和维护开销。
例如，更改安全协议将需要更改微服务代码，而扩展微服务将导致与授权服务器的更多连接。

==== 安全协议的变化需要微服务的变化

如果决定从 OAuth 2.0 转移到微服务上强制执行的安全协议，您必须在微服务中进行更改，即使它可能没有任何与其业务逻辑相关的更改。
此外，如果您发现当前安全实现中的错误，则需要修补微服务代码以修复它。
这种不必要的开销会损害设计、开发和部署微服务的敏捷性。

==== 扩展微服务导致与授权服务器的更多连接

需要运行更多的微服务实例来满足不断增长的需求。
想想双十一购物节，人们在您的零售网店下的订单比平时多，这需要您扩展微服务以满足需求。
由于每个微服务都与授权服务器对话以进行令牌验证，因此扩展微服务也会增加与授权服务器的连接数。

50 个用户使用单个微服务实例和 50 个用户使用 10 个微服务实例之间存在差异。
为了迎合这 50 个用户，单个微服务可能会维护一个大约 5 个的连接池来与授权服务器通信。
当微服务的每个实例维护 5 个连接池以连接到授权服务器时，10 个微服务实例最终会在授权服务器上创建 50 个连接，而不是 5 个。
图 3 说明了扩展微服务以满足增加的需求。

.3 微服务扩容时对授权服务器的影响，导致授权服务器负载增加
[caption="图 . "]
image::doc/3.3.dio.png[]

API 网关有助于将安全性与微服务分离。它拦截所有进入微服务的请求，与相应的授权进行对话，并仅将合法请求分派给上游微服务。
否则，它会向客户端应用程序返回一条错误消息。

=== 1.2 微服务部署固有的复杂性使其更难消费

一个微服务部署通常由许多微服务和这些微服务之间的许多交互组成（图 4）

.4 微服务部署的架构图，展示了服务和它们之间的连接
[caption="图 . "]
image::doc/3.4.dio.png[]

使用微服务来构建自己的功能的应用程序必须能够与多个微服务进行通信。
想象一个拥有多个团队的组织，其中每个团队都有职责开发图 4 中所示的微服务之一。
每个团队的开发人员可以使用自己的微服务技术堆栈以及自己的标准和实践。
这些微服务的不一致性让消费应用程序的开发人员很难，他们需要学习如何处理许多不一致的接口。

API 网关解决方案通常作为 API 管理软件的一部分提供，可以为向消费应用程序公开的接口带来一致性。
微服务本身可能不一致，因为它们现在对外界隐藏，而 API 网关可以处理与微服务交互的复杂性。

=== 1.3 微服务的原始性并不适合对外暴露

微服务可以根据需要进行细化。假设您的 Products 微服务中有两个操作：一个用于检索您的产品目录，另一个用于向目录中添加项目。
从 REST 的角度来看，检索产品的操作将在 `/products` 资源上建模为 `GET`，而添加产品的操作将在 `/products` 资源上建模为 `POST`。
`GET /products` 获取产品列表（读取操作）。 `POST /products` 将一个新产品添加到产品列表中（写操作）。

在实践中，您可以预期读取操作的请求比写入操作的请求多，因为在零售网站上，人们浏览产品的频率比添加到目录中的项目要频繁得多。
因此，您可以决定在两个不同的微服务（甚至可能是不同的技术堆栈）上实现 `GET` 和 `POST` 操作，以便它们可以独立扩展微服务。
该解决方案提高了健壮性，因为一个微服务的故障不会影响另一个微服务执行的操作。
然而，从消费的角度来看，消费应用程序必须与两个端点（两个 API）对话以进行添加和检索操作是很奇怪的。
强烈的 REST 拥护者可能会争辩说，将这两个操作放在同一个 API（同一个端点）上更有意义。

API 网关架构模式是解决此问题的理想解决方案。它为消费应用程序提供了一个具有两种资源（GET 和 POST）的 API。
每个资源都可以由自己的微服务支持，提供微服务层所需的可扩展性和健壮性（见图 5）。

.5 多个微服务在网关上作为单个 API 公开。客户端应用程序只需要关心一个端点。
[caption="图 . "]
image::doc/3.5.dio.png[]

== 2 边缘安全

我们将了解为什么 OAuth 2.0 是保护边缘微服务的最合适协议。在典型的微服务部署中，我们不会直接向客户端应用程序公开微服务。
API 网关是微服务部署的入口点，它有选择地将微服务作为 API 公开给客户端应用程序。

在大多数情况下，这些 API 网关使用 OAuth 2.0 作为安全协议来保护它们在边缘公开的 API。

=== 2.1 了解微服务的消费者格局

正如前面所讨论的，组织和企业采用微服务的主要原因是它们为开发服务提供的敏捷性。
组织希望尽可能敏捷地开发和部署服务。这一步伐是由消费类应用需求的增长推动的。
今天，人们在大多数日常活动中使用移动应用程序，例如订购比萨饼、杂货店购物、网络、社交互动和银行业务。这些移动应用程序使用来自不同提供商的服务。

在组织中，其内部和外部（例如第三方）应用程序都可以使用微服务。
外部应用程序可以是移动应用程序、公共互联网上的 Web 应用程序、运行在设备或汽车上的应用程序等。
要使这些类型的应用程序正常工作，需要通过 HTTPS 在公共互联网上公开您的微服务。
因此，不能仅仅依靠网络级安全策略来阻止对这些微服务的访问。
因此，可能总是不得不依赖上层安全来控制访问。
这里的上层安全是指 TCP/IP 协议栈（www.w3.org/People/Frystyk/thesis/TcpIp.html）中的层。
您需要依赖应用于网络层之上的安全，例如传输层或应用层协议，包括 TLS 和 HTTPS。

在组织的计算基础设施内运行的应用程序可能同时使用面向内部和面向外部的微服务。
面向内部的微服务也可能被其他面向外部或面向内部的微服务使用。
如图 6 所示，在零售网店示例中，用于浏览产品目录的微服务（产品微服务）和用于接单的微服务（订单处理微服务）是面向外部的微服务，它们需要在组织的安全边界之外运行的应用程序。
但是用于更新库存的微服务——库存微服务——不需要暴露在组织的安全边界之外，因为只有在下订单（通过订单处理微服务）或添加库存时才会更新库存通过内部应用程序进行盘点。


.6 内部微服务、外部微服务和混合微服务，每个微服务都相互通信以实现其功能
[caption="图 . "]
image::doc/3.6.dio.png[]

